<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirming Email - Skylon</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #0F3124 0%, #1a4d36 100%);
            color: white;
        }
        .container {
            text-align: center;
            padding: 2rem;
        }
        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #d4af37;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        h1 {
            color: #d4af37;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Confirming Your Email...</h1>
        <div class="spinner"></div>
        <p>Please wait while we verify your email address.</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>

    <script>
        async function confirmEmail() {
            const container = document.querySelector('.container');
            const h1 = container.querySelector('h1');
            const p = container.querySelector('p');
            const spinner = container.querySelector('.spinner');

            try {
                // 1. Pobierz parametry z URL (Nowy standard Supabase - PKCE)
                const urlParams = new URLSearchParams(window.location.search);
                const tokenHash = urlParams.get('token_hash');
                const type = urlParams.get('type');
                const errorCode = urlParams.get('error_code');
                const errorDescription = urlParams.get('error_description');

                // Obsługa błędów z URL
                if (errorCode) {
                    throw new Error(errorDescription || 'Verification link invalid');
                }

                // 2. Weryfikacja TOKEN_HASH (Najważniejsza część)
                if (tokenHash && type) {
                    const { error } = await supabaseClient.auth.verifyOtp({
                        token_hash: tokenHash,
                        type: type,
                    });

                    if (error) throw error;

                    // Sukces
                    finishSuccess();
                    return;
                }

                // 3. Fallback dla starych linków (Hash fragment)
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                const accessToken = hashParams.get('access_token');
                const refreshToken = hashParams.get('refresh_token');

                if (accessToken) {
                    const { error } = await supabaseClient.auth.setSession({
                        access_token: accessToken,
                        refresh_token: refreshToken
                    });
                    if (error) throw error;
                    finishSuccess();
                    return;
                }

                throw new Error('No verification token found. Link might be expired.');

            } catch (error) {
                console.error('Error:', error);
                spinner.style.display = 'none';
                h1.innerText = 'Verification Failed';
                h1.style.color = '#e74c3c'; // Red
                p.innerHTML = `${error.message}<br><br><a href="login.html" style="color: gold; text-decoration: underline;">Go to Login</a>`;
            }

            function finishSuccess() {
                spinner.style.display = 'none';
                h1.innerText = 'Email Confirmed!';
                h1.style.color = '#4caf50'; // Green
                p.innerText = 'Redirecting you to home...';
                
                // Przekierowanie po 2 sekundach
                setTimeout(() => {
                    window.location.href = 'index.html'; 
                }, 2000);
            }
        }

        // Uruchom po załadowaniu
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(confirmEmail, 500); // Małe opóźnienie dla pewności załadowania libki
        });
    </script>
</body>
</html>